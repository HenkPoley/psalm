<?php

declare(strict_types=1);

use Webmozart\Assert\Assert;

require __DIR__ . '/gen_callmap_utils.php';

// Load+normalize autogenerated maps
$baseMaps = [];
foreach (glob(__DIR__."/../dictionaries/autogen/CallMap_*.php") as $file) {
    Assert::eq(preg_match('/_(\d+)\.php/', $file, $matches), 1);
    $version = $matches[1];

    $baseMaps[$version] = normalizeCallMap(require $file);
    writeCallMap($file, $baseMaps[$version]);
}

ksort($baseMaps);
$last = array_key_last($baseMaps);

// Load+normalize hand-written diff maps
$customMaps = [
    $last => normalizeCallMap(require __DIR__."/../dictionaries/override/CallMap.php")
];

$customDiffs = [];
foreach (glob(__DIR__."/../dictionaries/override/CallMap_*.php") as $file) {
    Assert::eq(preg_match('/_(\d+)_delta\.php/', $file, $matches), 1);
    $version = $matches[1];
    $customDiffs[$version] = normalizeCallMap(require $file);
}
krsort($customDiffs);

$versions = array_reverse(array_keys($customDiffs));

// Merge hand-written diff maps to generate hand-written full maps
foreach ($customDiffs as $version => $customDiff) {
    $customMap = $customMaps[$version];

    foreach ($customDiff['removed'] as $func => $descr) {
        $customMap[$func] = $descr;
    }
    foreach ($customDiff['added'] as $func => $descr) {
        unset($customMap[$func]);
    }
    foreach ($customDiff['changed'] as $func => $sub) {
        $customMap[$func] = $sub['old'];
    }

    $prevVersion = array_search($version, $versions)-1;
    if ($prevVersion < 0) {
        continue;
    }
    $customMaps[$versions[$prevVersion]] = $customMap;
}
krsort($customMaps);

// Merge hand-written full maps into autogenerated full maps, write to files
foreach ($customMaps as $version => $data) {
    writeCallMap("dictionaries/CallMap_$version.php", array_replace($baseMaps[$version] ?? [], $data));
}

// Cleanup hand-written full maps, removing data that is the same in the autogenerated full maps
foreach ($customMaps as $version => &$data) {
    foreach ($data as $name => $func) {
        if (($baseMaps[$version][$name] ?? null) === $func) {
            unset($data[$name]);
        }
    }
    $data = normalizeCallMap($data);
} unset($data);

// Write base custom map
writeCallMap(__DIR__."/../dictionaries/override/CallMap.php", $customMaps[$last]);

$customDiffs = [];

foreach ($customMaps as $version => $cur) {
    $prevVersion = array_search($version, $versions)-1;
    if ($prevVersion < 0) {
        continue;
    }
    $prevVersion = $versions[$prevVersion];

    $prev = $customMaps[$prevVersion];

    $diff = ['changed' => [], 'added' => [], 'removed' => []];
    foreach ($prev as $name => $func) {
        if (!isset($cur[$name])) {
            $diff['removed'][$name] = $func;
        } else if ($cur[$name] !== $func) {
            $diff['changed'][$name] = [
                'old' => $func,
                'new' => $cur[$name]
            ];
        }
    }

    foreach ($cur as $name => $func) {
        if (!isset($prev[$name])) {
            $diff['added'][$name] = $func;
        }
    }

    writeCallMap("dictionaries/override/CallMap_$version.php", $diff);
}